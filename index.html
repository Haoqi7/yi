<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç†Šç†Šè¯­è½¬æ¢å™¨ V6.3</title>
    <style>
        :root {
            --primary: #FF6B6B;
            --secondary: #4ECDC4;
            --bg: #F8F9FA;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: var(--bg);
            font-family: -apple-system, system-ui;
        }
        .header {
            text-align: center;
            margin: 2rem 0;
        }
        .converter-box {
            position: relative;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin: 1.5rem 0;
        }
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--secondary);
            border-radius: 10px;
            font-size: 16px;
            min-height: 120px;
            resize: vertical;
            margin-bottom: 1rem;
        }
        .mode-switch {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 1.5rem 0;
        }
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        button.active {
            background: #FF4500;
            box-shadow: 0 2px 6px rgba(255,107,107,0.3);
        }
        #output {
            position: relative;
            white-space: pre-wrap;
            word-break: break-word;
            padding: 15px;
            background: #fff8f5;
            border-radius: 10px;
            min-height: 120px;
            font-size: 16px;
            line-height: 1.6;
        }
        .copy-btn {
            position: absolute;
            right: 15px;
            top: 15px;
            padding: 6px 12px;
            font-size: 0.9em;
            background: var(--secondary);
        }
        footer {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            padding: 1.5rem;
        }
        #status {
            color: #666;
            font-size: 0.9rem;
            padding: 10px;
            text-align: center;
        }
        .title-image {
            width: 50px;
            height: 50px;
            vertical-align: middle;
        }
        .output-tag {
            font-size: 0.8em;
            color: #666;
            padding: 2px 4px;
            border-radius: 3px;
            margin-left: 5px;
            display: inline-block;
        }
        .dict-tag { background: #e3f2fd; }
        .encode-tag { background: #f0f4c3; }
        .decode-tag { background: #c8e6c9; }
        #code-tags {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        @media (max-width: 480px) {
            .mode-switch {
                grid-template-columns: 1fr;
            }
            .copy-btn {
                position: static;
                margin-top: 10px;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <img src="./logo.png" class="title-image">
              ç†Šç†Šè¯­è½¬æ¢å™¨ ğŸ”¥
        </h1>
        <p>ä¸€äºŒå¸ƒå¸ƒæ˜Ÿçƒçš„ç§˜å¯†é€šä¿¡æ–¹å¼</p>
    </div>

    <div class="converter-box">
        <textarea id="input" placeholder="è¾“å…¥ä¸­æ–‡æˆ–ç†Šè¯­..."></textarea>
        <div class="mode-switch">
            <button class="active" data-mode="auto">è‡ªåŠ¨æ£€æµ‹ ğŸ”„</button>
            <button data-mode="cn2bear">ä¸­æ–‡ â†’ ç†Šè¯­</button>
            <button data-mode="bear2cn">ç†Šè¯­ â†’ ä¸­æ–‡</button>
        </div>
        <div id="output">
            <button class="copy-btn" onclick="App.copyResult()">å¤åˆ¶ç»“æœ</button>
            <div id="conversion-result"></div>
            <div id="code-tags"></div>
        </div>
        <div id="status">â³ æ­£åœ¨åŠ è½½è¯åº“...</div>
    </div>

    <footer>
        <p>Â© 2024 ç†Šè¯­ç ”ç©¶åä¼š | é‡‡ç”¨ç†Šè€³ç¼–ç æ ‡å‡† v2</p>
    </footer>

    <script>
        class BearTranslator {
            static #dictionary = {
                cn: new Map(),
                bear: new Map(),
                loaded: false
            };

            static #config = {
                bitLength: 16,
                separator: 'Â·',
                binaryMap: { '0': 'å•Š', '1': 'å“’' },
                minBearLength: 3
            };

            static async init() {
                try {
                    await this.#loadDictionary();
                    this.#updateStatus('âœ… è¯åº“åŠ è½½å®Œæˆ');
                    this.#dictionary.loaded = true;
                } catch (e) {
                    this.#updateStatus('âš ï¸ è¯åº“åŠ è½½å¤±è´¥ï¼Œä»…ä½¿ç”¨ç¼–ç è½¬æ¢');
                    this.#dictionary.cn.clear();
                    this.#dictionary.bear.clear();
                    this.#dictionary.loaded = false;
                }
            }

            static async #loadDictionary() {
                const response = await fetch('./dictionary.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                if (!data.main) throw new Error('Invalid dictionary format');
                
                // æ¸…é™¤æ—§æ•°æ®
                this.#dictionary.cn.clear();
                this.#dictionary.bear.clear();
                
                // åŠ è½½æ–°æ•°æ®
                Object.entries(data.main).forEach(([key, value]) => {
                    this.#dictionary.cn.set(key, value);
                    this.#dictionary.bear.set(value, key);
                });
            }

            static convert(text, mode) {
                const realMode = mode === 'auto' ? 
                    this.#detectLanguage(text) : mode;
                
                const result = realMode === 'cn2bear' ? 
                    this.#encode(text) : 
                    this.#decode(text);
                
                return {
                    displayText: result.map(r => r.text).join(' '),
                    details: result
                };
            }

            static #detectLanguage(text) {
                const cnChars = text.match(/[\u4e00-\u9fa5]/g)?.length || 0;
                const bearTokens = text.match(/[å“’å•ŠÂ·~]/g)?.length || 0;
                return cnChars > bearTokens ? 'cn2bear' : 'bear2cn';
            }

            static #encode(text) {
                return [...text].map(char => {
                    // ä¼˜å…ˆä½¿ç”¨å­—å…¸è½¬æ¢
                    if (this.#dictionary.loaded) {
                        const dictResult = this.#dictionary.cn.get(char);
                        if (dictResult) {
                            return { text: dictResult, type: 'dict' };
                        }
                    }
                    
                    // å­—å…¸æœªåŠ è½½æˆ–æ‰¾ä¸åˆ°æ—¶ä½¿ç”¨ç¼–ç 
                    return {
                        text: this.#encodeBinary(char),
                        type: 'encode'
                    };
                });
            }

            static #encodeBinary(char) {
                const binStr = char.charCodeAt(0)
                    .toString(2)
                    .padStart(this.#config.bitLength, '0');
                
                return [...binStr].map(b => 
                    this.#config.binaryMap[b]
                ).join('') + this.#config.separator;
            }

            static #decode(text) {
                return text.split(/[\sÂ·]+/).map(token => {
                    // ä¼˜å…ˆä½¿ç”¨å­—å…¸è½¬æ¢
                    if (this.#dictionary.loaded) {
                        const dictResult = this.#dictionary.bear.get(token);
                        if (dictResult) {
                            return { text: dictResult, type: 'dict' };
                        }
                    }
                    
                    // å°è¯•äºŒè¿›åˆ¶è§£ç 
                    const decodeResult = this.#decodeBinary(token);
                    if (decodeResult !== token) {
                        return { text: decodeResult, type: 'decode' };
                    }
                    
                    return { text: token, type: 'unknown' };
                });
            }

            static #decodeBinary(token) {
                const clean = token.replace(/[^å“’å•Š]/g, '');
                if (clean.length !== this.#config.bitLength) return token;
                
                const binStr = clean.replace(/å“’/g, '1').replace(/å•Š/g, '0');
                try {
                    return String.fromCharCode(parseInt(binStr, 2));
                } catch {
                    return ' ';
                }
            }

            static #updateStatus(msg) {
                document.getElementById('status').textContent = msg;
            }
        }

        class App {
            static #currentMode = 'auto';
            static #debounceTimer;

            static init() {
                BearTranslator.init();
                
                document.getElementById('input').addEventListener('input', () => 
                    this.#convertWithDebounce(300));
                
                document.querySelectorAll('.mode-switch button').forEach(btn => {
                    btn.addEventListener('click', () => 
                        this.#setMode(btn.dataset.mode));
                });
            }

            static #setMode(mode) {
                this.#currentMode = mode;
                document.querySelectorAll('.mode-switch button')
                    .forEach(b => b.classList.remove('active'));
                document.querySelector(`[data-mode="${mode}"]`)
                    .classList.add('active');
                this.#convertWithDebounce(0);
            }

            static #convertWithDebounce = (() => {
                return (delay) => {
                    clearTimeout(this.#debounceTimer);
                    this.#debounceTimer = setTimeout(() => {
                        const input = document.getElementById('input').value;
                        const result = BearTranslator.convert(input, this.#currentMode);
                        this.#updateUI(result);
                    }, delay);
                };
            })();

            static #updateUI(result) {
                const resultDiv = document.getElementById('conversion-result');
                const tagsDiv = document.getElementById('code-tags');
                
                resultDiv.textContent = result.displayText;
                
                tagsDiv.innerHTML = result.details.map(part => {
                    let tagClass = '';
                    let tagText = '';
                    switch(part.type) {
                        case 'dict':
                            tagClass = 'dict-tag';
                            tagText = 'è¯å…¸';
                            break;
                        case 'encode':
                            tagClass = 'encode-tag';
                            tagText = 'ç¼–ç ';
                            break;
                        case 'decode':
                            tagClass = 'decode-tag';
                            tagText = 'è§£ç ';
                            break;
                        default:
                            tagClass = '';
                            tagText = 'æœªçŸ¥';
                    }
                    return `<span class="output-tag ${tagClass}">${tagText}</span>`;
                }).join(' ');
            }

            static copyResult() {
                const text = document.getElementById('conversion-result').textContent;
                navigator.clipboard.writeText(text).then(() => {
                    const status = document.getElementById('status');
                    status.textContent = 'âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼';
                    setTimeout(() => status.textContent = 'âœ… ç³»ç»Ÿè¿è¡Œä¸­', 2000);
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    document.getElementById('status').textContent = 'âš ï¸ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶';
                });
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        App.init();
    </script>
</body>
</html>
