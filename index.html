<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>熊熊语转换器 V6.8</title>
    <style>
        :root {
            --primary: #FF6B6B;
            --secondary: #4ECDC4;
            --bg: #F8F9FA;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: var(--bg);
            font-family: -apple-system, system-ui;
        }
        .header {
            text-align: center;
            margin: 0.8rem 0 1.2rem;
        }
        .header h1 {
            margin: 0.5em 0;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .header p {
            margin-bottom: 0.3em;
            color: #666;
        }
        .converter-box {
            position: relative;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin: 1.5rem 0;
        }
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--secondary);
            border-radius: 10px;
            font-size: 16px;
            min-height: 120px;
            resize: vertical;
            margin-bottom: 1rem;
        }
        .mode-switch {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 1.5rem 0;
        }
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        button.active {
            background: #FF4500;
            box-shadow: 0 2px 6px rgba(255,107,107,0.3);
        }
        #output {
            position: relative;
            display: flex;
            flex-direction: column;
            white-space: pre-wrap;
            word-break: break-word;
            padding: 15px;
            background: #fff8f5;
            border-radius: 10px;
            min-height: 120px;
            font-size: 16px;
            line-height: 1.6;
        }
        .copy-btn {
            position: absolute;
            right: 15px;
            top: 15px;
            padding: 6px 12px;
            font-size: 0.9em;
            background: var(--secondary);
            z-index: 1;
        }
        footer {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            padding: 1.5rem;
        }
        #status {
            color: #666;
            font-size: 0.9rem;
            padding: 10px;
            text-align: center;
        }
        .title-image {
            width: 50px;
            height: 50px;
            vertical-align: middle;
        }
        .output-tag {
            font-size: 0.8em;
            color: #666;
            padding: 2px 4px;
            border-radius: 3px;
            margin-left: 5px;
            display: inline-block;
        }
        .dict-tag { background: #e3f2fd; }
        .encode-tag { background: #f0f4c3; }
        .decode-tag { background: #c8e6c9; }
        #code-tags {
            margin-top: auto;
            padding: 10px 0 0;
            width: 100%;
            border-top: 1px solid #eee;
        }
        #conversion-result {
            flex: 1;
            padding-bottom: 15px;
        }
        @media (max-width: 420px) {
            .mode-switch {
                grid-template-columns: 1fr;
            }
            .converter-box {
                padding: 1rem;
            }
            #output {
                padding: 15px 10px;
            }
            .copy-btn {
                padding: 8px;
                font-size: 0.8em;
            }
            textarea {
                padding: 12px;
                font-size: 15px;
            }
            .header h1 {
                font-size: 1.6em;
                margin: 0.3em 0;
                flex-wrap: wrap;
            }
            .header p {
                font-size: 0.9em;
            }
            .title-image {
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <img src="./logo.png" class="title-image">
            <span>熊熊语转换器 🔥</span>
        </h1>
        <p>一二布布星球的秘密通信方式</p>
    </div>

    <div class="converter-box">
        <textarea id="input" placeholder="输入中文或熊语..."></textarea>
        <div class="mode-switch">
            <button class="active" data-mode="auto">自动检测 🔄</button>
            <button data-mode="cn2bear">中文 → 熊语</button>
            <button data-mode="bear2cn">熊语 → 中文</button>
        </div>
        <div id="output">
            <button class="copy-btn" onclick="App.copyResult()">复制结果</button>
            <div id="conversion-result"></div>
            <div id="code-tags"></div>
        </div>
        <div id="status">⏳ 正在加载词库...</div>
    </div>

    <footer><p>© 2024 熊语研究协会 | 采用熊耳四进制编码标准</p></footer>

    <script>
        class BearTranslator {
            static #dictionary = {
                cn: {
                    single: new Map(),
                    phrases: new Map(),
                    maxLength: 1
                },
                bear: new Map(),
                loaded: false
            };

            static #config = {
                bitLength: 16,
                separator: '·',
                base4Map: new Map([
                    ['00', '啊'], ['01', '哒'],
                    ['10', '.'], ['11', '~']
                ]),
                reverseBase4Map: new Map([
                    ['啊', '00'], ['哒', '01'],
                    ['.', '10'], ['~', '11']
                ])
            };

            static async init() {
                try {
                    await this.#loadDictionary();
                    this.#updateStatus('✅ 词库加载完成');
                    this.#dictionary.loaded = true;
                } catch (e) {
                    this.#updateStatus('⚠️ 词库加载失败，仅使用编码转换');
                    this.#resetDictionary();
                }
            }

            static async #loadDictionary() {
                const response = await fetch('./dictionary.json');
                const data = await response.json();
                
                this.#resetDictionary();
                Object.entries(data.main).forEach(([key, value]) => {
                    if (key === "了") return;

                    if (key.length === 1) {
                        this.#dictionary.cn.single.set(key, value);
                    } else {
                        const len = key.length;
                        if (!this.#dictionary.cn.phrases.has(len)) {
                            this.#dictionary.cn.phrases.set(len, new Map());
                        }
                        this.#dictionary.cn.phrases.get(len).set(key, value);
                        this.#dictionary.cn.maxLength = Math.max(this.#dictionary.cn.maxLength, len);
                    }
                    this.#dictionary.bear.set(value, key);
                });
            }

            static #resetDictionary() {
                this.#dictionary.cn.single.clear();
                this.#dictionary.cn.phrases.clear();
                this.#dictionary.bear.clear();
                this.#dictionary.cn.maxLength = 1;
            }

            static convert(text, mode) {
                const realMode = mode === 'auto' ? 
                    this.#detectLanguage(text) : mode;
                
                return realMode === 'cn2bear' ? 
                    this.#encodeChinese(text) : 
                    this.#decodeBear(text);
            }

            static #detectLanguage(text) {
                const cnChars = text.match(/[\u4e00-\u9fa5]/g)?.length || 0;
                const bearTokens = text.match(/[哒啊·~.]/g)?.length || 0;
                return cnChars > bearTokens ? 'cn2bear' : 'bear2cn';
            }

            static #encodeChinese(text) {
                const result = [];
                let pos = 0;
                const totalLen = text.length;

                while (pos < totalLen) {
                    const currentChar = text[pos];
                    if (currentChar === "了") {
                        pos++;
                        continue;
                    }

                    let matched = false;
                    const maxCheck = Math.min(
                        this.#dictionary.cn.maxLength,
                        totalLen - pos
                    );

                    for (let checkLen = maxCheck; checkLen >= 1; checkLen--) {
                        const candidate = text.substr(pos, checkLen);
                        const dictMap = checkLen === 1 ? 
                            this.#dictionary.cn.single : 
                            (this.#dictionary.cn.phrases.get(checkLen) || new Map());

                        if (dictMap.has(candidate)) {
                            result.push({
                                text: dictMap.get(candidate),
                                type: 'dict'
                            });
                            pos += checkLen;
                            matched = true;
                            break;
                        }
                    }

                    if (!matched) {
                        result.push({
                            text: this.#encodeBinary(text[pos]),
                            type: 'encode'
                        });
                        pos++;
                    }
                }
                
                return {
                    displayText: result.map(r => r.text).join(' '),
                    details: result
                };
            }

            static #encodeBinary(char) {
                const binStr = char.charCodeAt(0)
                    .toString(2)
                    .padStart(this.#config.bitLength, '0');
                
                let encoded = '';
                for(let i=0; i<binStr.length; i+=2) {
                    const pair = binStr.substr(i, 2);
                    encoded += this.#config.base4Map.get(pair) || '??';
                }
                return encoded + this.#config.separator;
            }

            static #decodeBear(text) {
                const tokens = text.split(/[\s·]+/);
                const result = [];

                for (const token of tokens) {
                    if (this.#dictionary.bear.has(token)) {
                        result.push({
                            text: this.#dictionary.bear.get(token),
                            type: 'dict'
                        });
                    } else {
                        const decoded = this.#decodeBinary(token);
                        result.push({
                            text: decoded !== token ? decoded : token,
                            type: decoded !== token ? 'decode' : 'unknown'
                        });
                    }
                }
                
                return {
                    displayText: result.map(r => r.text).join(''),
                    details: result
                };
            }

            static #decodeBinary(token) {
                const clean = token.replace(/[^啊哒.~]/g, '');
                if(clean.length !== this.#config.bitLength/2) return token;

                let binStr = '';
                for(const c of clean) {
                    binStr += this.#config.reverseBase4Map.get(c) || '00';
                }

                try {
                    return String.fromCharCode(parseInt(binStr, 2));
                } catch {
                    return '�';
                }
            }

            static #updateStatus(msg) {
                document.getElementById('status').textContent = msg;
            }
        }

        class App {
            static #currentMode = 'auto';
            static #debounceTimer;

            static init() {
                BearTranslator.init();
                
                document.getElementById('input').addEventListener('input', () => 
                    this.#convertWithDebounce(300));
                
                document.querySelectorAll('.mode-switch button').forEach(btn => {
                    btn.addEventListener('click', () => 
                        this.#setMode(btn.dataset.mode));
                });
            }

            static #setMode(mode) {
                this.#currentMode = mode;
                document.querySelectorAll('.mode-switch button')
                    .forEach(b => b.classList.remove('active'));
                document.querySelector(`[data-mode="${mode}"]`)
                    .classList.add('active');
                this.#convertWithDebounce(0);
            }

            static #convertWithDebounce = (() => {
                return (delay) => {
                    clearTimeout(this.#debounceTimer);
                    this.#debounceTimer = setTimeout(() => {
                        const input = document.getElementById('input').value;
                        const result = BearTranslator.convert(input, this.#currentMode);
                        this.#updateUI(result);
                    }, delay);
                };
            })();

            static #updateUI(result) {
                const resultDiv = document.getElementById('conversion-result');
                const tagsDiv = document.getElementById('code-tags');
                
                resultDiv.textContent = result.displayText;
                
                tagsDiv.innerHTML = result.details.map(part => {
                    let tagClass = '';
                    let tagText = '';
                    switch(part.type) {
                        case 'dict': 
                            tagClass = 'dict-tag';
                            tagText = '词典';
                            break;
                        case 'encode':
                            tagClass = 'encode-tag';
                            tagText = '编码';
                            break;
                        case 'decode':
                            tagClass = 'decode-tag';
                            tagText = '解码';
                            break;
                        default:
                            tagClass = '';
                            tagText = '直译';
                    }
                    return `<span class="output-tag ${tagClass}">${tagText}</span>`;
                }).join(' ');
            }

            static copyResult() {
                const text = document.getElementById('conversion-result').textContent;
                navigator.clipboard.writeText(text).then(() => {
                    const status = document.getElementById('status');
                    status.textContent = '✅ 已复制到剪贴板！';
                    setTimeout(() => status.textContent = '✅ 系统运行中', 2000);
                }).catch(err => {
                    console.error('复制失败:', err);
                    document.getElementById('status').textContent = '⚠️ 复制失败，请手动选择复制';
                });
            }
        }

        App.init();
    </script>
</body>
</html>
