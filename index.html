<!-- index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç†Šç†Šè¯­è½¬æ¢å™¨ V4.1</title>
    <style>
        :root {
            --primary: #FF6B6B;
            --secondary: #4ECDC4;
            --bg: #F8F9FA;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: var(--bg);
            font-family: -apple-system, system-ui;
        }
        .header {
            text-align: center;
            margin: 2rem 0;
        }
        .converter-box {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin: 1.5rem 0;
        }
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--secondary);
            border-radius: 10px;
            font-size: 16px;
            min-height: 120px;
            resize: vertical;
            margin-bottom: 1rem;
        }
        .mode-switch {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 1.5rem 0;
        }
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        button.active {
            background: #FF4500;
            box-shadow: 0 2px 6px rgba(255,107,107,0.3);
        }
        #output {
            white-space: pre-wrap;
            word-break: break-word;
            padding: 15px;
            background: #fff8f5;
            border-radius: 10px;
            min-height: 120px;
            font-size: 16px;
            line-height: 1.6;
        }
        footer {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            padding: 1.5rem;
        }
        .title-image {
            width: 50px;
            height: 50px;
            vertical-align: middle;
        }
        #status {
            color: #666;
            font-size: 0.9rem;
            padding: 10px;
            text-align: center;
        }
        @media (max-width: 480px) {
            .mode-switch {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><img src="./logo.png" class="title-image">ç†Šç†Šè¯­è½¬æ¢å™¨ ğŸ”¥</h1>
        <p>ä¸€äºŒå¸ƒå¸ƒæ˜Ÿçƒçš„ç§˜å¯†é€šä¿¡æ–¹å¼</p>
    </div>



    <div class="converter-box">
        <textarea id="input" placeholder="è¾“å…¥ä¸­æ–‡æˆ–ç†Šè¯­..."></textarea>
        <div class="mode-switch">
            <button class="active" data-mode="auto">è‡ªåŠ¨æ£€æµ‹ ğŸ”„</button>
            <button data-mode="cn2bear">ä¸­æ–‡ â†’ ç†Šè¯­</button>
            <button data-mode="bear2cn">ç†Šè¯­ â†’ ä¸­æ–‡</button>
        </div>
        <div id="output"></div>
        <div id="status">ç³»ç»Ÿå°±ç»ª</div>
    </div>

    <footer>
        <p>Â© 2024 ç†Šè¯­ç ”ç©¶åä¼š | é‡‡ç”¨ç†Šè€³ç¼–ç æ ‡å‡† v2</p>
    </footer>

    <script>
        class BearTranslator {
            static #dictionary = {
                cn: new Map(),
                bear: new Map(),
                symbols: new Map([
                    ['!', '~'], ['ï¼Ÿ', '??'], ['ï¼', '!!'], 
                    ['â¤', 'â™¥'], ['...', '~~~']
                ])
            };

            static #config = {
                bitLength: 16,
                separator: 'Â·',
                binaryMap: { '0': 'å•Š', '1': 'å“’' },
                minBearLength: 3
            };

            static async init() {
                await this.#loadDictionary();
                this.#updateStatus('âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            }

            static async #loadDictionary() {
                try {
                    const response = await fetch('dictionary.json');
                    const data = await response.json();
                    
                    // åŠ è½½ä¸»è¯å…¸
                    Object.entries(data.main).forEach(([cn, bear]) => {
                        this.#dictionary.cn.set(cn, bear);
                        this.#dictionary.bear.set(bear, cn);
                    });
                    
                    // åŠ è½½ç¬¦å·è¯å…¸
                    Object.entries(data.symbols).forEach(([key, val]) => {
                        this.#dictionary.symbols.set(key, val);
                        this.#dictionary.bear.set(val, key);
                    });
                    
                } catch (e) {
                    this.#updateStatus('âš ï¸ è¯å…¸åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€è¯åº“');
                    this.#loadFallbackDict();
                }
            }

            static #loadFallbackDict() {
                const fallback = {
                    main: {
                        "æˆ‘": "å“’", "ä½ ": "å•Šå“’", "çš„": "å•Š",
                        "äº†": "å“’å“’", "æ˜¯": "å•Šå•Šå•Š"
                    },
                    symbols: {
                        "!": "~", "ï¼Ÿ": "??"
                    }
                };
                
                Object.entries(fallback.main).forEach(([cn, bear]) => {
                    this.#dictionary.cn.set(cn, bear);
                    this.#dictionary.bear.set(bear, cn);
                });
                
                Object.entries(fallback.symbols).forEach(([k, v]) => {
                    this.#dictionary.symbols.set(k, v);
                    this.#dictionary.bear.set(v, k);
                });
            }

            static convert(text, mode) {
                const realMode = mode === 'auto' ? 
                    this.#detectLanguage(text) : mode;
                
                return realMode === 'cn2bear' ? 
                    this.#encode(text) : 
                    this.#decode(text);
            }

            static #detectLanguage(text) {
                const cnChars = text.match(/[\u4e00-\u9fa5]/g)?.length || 0;
                const bearTokens = text.match(/[å“’å•ŠÂ·~]/g)?.length || 0;
                return cnChars > bearTokens ? 'cn2bear' : 'bear2cn';
            }

            static #encode(text) {
                return [...text].map(char => 
                    this.#dictionary.symbols.get(char) ||
                    this.#dictionary.cn.get(char) ||
                    this.#encodeBinary(char)
                ).join(' ');
            }

            static #encodeBinary(char) {
                const binStr = char.charCodeAt(0)
                    .toString(2)
                    .padStart(this.#config.bitLength, '0');
                
                return [...binStr].map(b => 
                    this.#config.binaryMap[b]
                ).join('') + this.#config.separator;
            }

            static #decode(text) {
                return text.split(/[\sÂ·]+/)
                    .map(token => {
                        return this.#dictionary.bear.get(token) ||
                               this.#decodeBinary(token) ||
                               token;
                    }).join('');
            }

            static #decodeBinary(token) {
                const clean = token.replace(/[^å“’å•Š]/g, '');
                if (clean.length !== this.#config.bitLength) return token;
                
                const binStr = clean.replace(/å“’/g, '1').replace(/å•Š/g, '0');
                try {
                    return String.fromCharCode(parseInt(binStr, 2));
                } catch {
                    return ' ';
                }
            }

            static #updateStatus(msg) {
                document.getElementById('status').textContent = msg;
            }
        }

        class App {
            static #currentMode = 'auto';
            static #debounceTimer;

            static init() {
                BearTranslator.init();
                
                document.getElementById('input').addEventListener('input', () => 
                    this.#convertWithDebounce(300));
                
                document.querySelectorAll('.mode-switch button').forEach(btn => {
                    btn.addEventListener('click', () => 
                        this.#setMode(btn.dataset.mode));
                });
            }

            static #setMode(mode) {
                this.#currentMode = mode;
                document.querySelectorAll('.mode-switch button')
                    .forEach(b => b.classList.remove('active'));
                document.querySelector(`[data-mode="${mode}"]`)
                    .classList.add('active');
                this.#convertWithDebounce(0);
            }

            static #convertWithDebounce = (() => {
                return (delay) => {
                    clearTimeout(this.#debounceTimer);
                    this.#debounceTimer = setTimeout(() => {
                        const input = document.getElementById('input').value;
                        const output = BearTranslator.convert(input, this.#currentMode);
                        document.getElementById('output').textContent = output;
                    }, delay);
                };
            })();
        }

        // åˆå§‹åŒ–åº”ç”¨
        App.init();
    </script>
</body>
</html>
