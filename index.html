<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>熊熊语转换器 V6.0</title>
    <style>
        :root {
            --primary: #FF6B6B;
            --secondary: #4ECDC4;
            --bg: #F8F9FA;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: var(--bg);
            font-family: -apple-system, system-ui;
        }
        .header {
            text-align: center;
            margin: 2rem 0;
        }
        .converter-box {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin: 1.5rem 0;
            position: relative;
        }
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--secondary);
            border-radius: 10px;
            font-size: 16px;
            min-height: 120px;
            resize: vertical;
            margin-bottom: 1rem;
        }
        .mode-switch {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 1.5rem 0;
        }
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        button.active {
            background: #FF4500;
            box-shadow: 0 2px 6px rgba(255,107,107,0.3);
        }
        #output {
            position: relative;
            white-space: pre-wrap;
            word-break: break-word;
            padding: 15px;
            background: #fff8f5;
            border-radius: 10px;
            min-height: 150px;
            font-size: 16px;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
        }
        #copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            font-size: 0.9em;
            background: var(--secondary);
        }
        footer {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            padding: 1.5rem;
        }
        #status {
            color: #666;
            font-size: 0.9rem;
            padding: 10px;
            text-align: center;
        }
        .title-image {
            width: 50px;
            height: 50px;
            vertical-align: middle;
        }
        .output-tag {
            font-size: 0.8em;
            color: #666;
            padding: 2px 4px;
            border-radius: 3px;
            margin-left: 5px;
            display: inline-block;
        }
        .dict-tag { background: #e3f2fd; }
        .encode-tag { background: #f0f4c3; }
        .symbol-tag { background: #ffcdd2; }
        .decode-tag { background: #c8e6c9; }
        #code-tags {
            margin-top: auto;
            padding: 10px 0 0;
            border-top: 1px dashed #ddd;
        }
        @media (max-width: 480px) {
            .mode-switch {
                grid-template-columns: 1fr;
            }
            #output {
                min-height: 120px;
                padding-top: 40px;
            }
            #copy-btn {
                top: 5px;
                right: 5px;
                padding: 6px 10px;
            }
            .converter-box {
                padding: 1rem;
            }
            textarea {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <img src="./logo.png" class="title-image">
              熊熊语转换器 🔥
        </h1>
        <p>一二布布星球的秘密通信方式</p>
    </div>

    <div class="converter-box">
        <textarea id="input" placeholder="输入中文或熊语..."></textarea>
        <div class="mode-switch">
            <button class="active" data-mode="auto">自动检测 🔄</button>
            <button data-mode="cn2bear">中文 → 熊语</button>
            <button data-mode="bear2cn">熊语 → 中文</button>
        </div>
        <div id="output">
            <button id="copy-btn">复制结果</button>
            <div id="conversion-result"></div>
            <div id="code-tags"></div>
        </div>
        <div id="status">✅ 系统初始化完成</div>
    </div>

    <footer>
        <p>© 2024 熊语研究协会 | 采用熊耳编码标准 v2</p>
    </footer>

    <script>
        class BearTranslator {
            static #dictionary = {
                cn: new Map(),
                bear: new Map(),
                symbols: new Map([
                    ['!', '~'], ['？', '??'], ['！', '!!'], 
                    ['❤', '♥'], ['...', '~~~']
                ])
            };

            static #config = {
                bitLength: 16,
                separator: '·',
                binaryMap: { '0': '啊', '1': '哒' },
                minBearLength: 3
            };

            static async init() {
                await this.#loadDictionary();
                this.#updateStatus('✅ 系统运行中 - 词库加载完成');
            }

            static async #loadDictionary() {
                try {
                    const response = await fetch('dictionary.json');
                    const data = await response.json();
                    
                    Object.entries(data.main).forEach(([cn, bear]) => {
                        this.#dictionary.cn.set(cn, bear);
                        this.#dictionary.bear.set(bear, cn);
                    });
                    
                    Object.entries(data.symbols).forEach(([key, val]) => {
                        this.#dictionary.symbols.set(key, val);
                        this.#dictionary.bear.set(val, key);
                    });
                    
                } catch (e) {
                    this.#updateStatus('⚠️ 词典加载失败，使用基础词库');
                    this.#loadFallbackDict();
                }
            }

            static #loadFallbackDict() {
                const fallback = {
                    main: {
                        "我": "哒", "你": "啊哒", "的": "啊",
                        "了": "哒哒", "是": "啊啊啊"
                    },
                    symbols: {
                        "!": "~", "？": "??"
                    }
                };
                
                Object.entries(fallback.main).forEach(([cn, bear]) => {
                    this.#dictionary.cn.set(cn, bear);
                    this.#dictionary.bear.set(bear, cn);
                });
                
                Object.entries(fallback.symbols).forEach(([k, v]) => {
                    this.#dictionary.symbols.set(k, v);
                    this.#dictionary.bear.set(v, k);
                });
            }

            static convert(text, mode) {
                const realMode = mode === 'auto' ? 
                    this.#detectLanguage(text) : mode;
                
                const result = realMode === 'cn2bear' ? 
                    this.#encode(text) : 
                    this.#decode(text);
                
                return {
                    displayText: result.map(r => r.text).join(' '),
                    details: result
                };
            }

            static #detectLanguage(text) {
                const cnChars = text.match(/[\u4e00-\u9fa5]/g)?.length || 0;
                const bearTokens = text.match(/[哒啊·~]/g)?.length || 0;
                return cnChars > bearTokens ? 'cn2bear' : 'bear2cn';
            }

            static #encode(text) {
                return [...text].map(char => {
                    const symbol = this.#dictionary.symbols.get(char);
                    if (symbol) {
                        return { text: symbol, type: 'symbol' };
                    }
                    
                    const dictResult = this.#dictionary.cn.get(char);
                    if (dictResult) {
                        return { text: dictResult, type: 'dict' };
                    }
                    
                    return {
                        text: this.#encodeBinary(char),
                        type: 'encode'
                    };
                });
            }

            static #encodeBinary(char) {
                const binStr = char.charCodeAt(0)
                    .toString(2)
                    .padStart(this.#config.bitLength, '0');
                
                return [...binStr].map(b => 
                    this.#config.binaryMap[b]
                ).join('') + this.#config.separator;
            }

            static #decode(text) {
                return text.split(/[\s·]+/).map(token => {
                    const dictResult = this.#dictionary.bear.get(token);
                    if (dictResult) {
                        return { text: dictResult, type: 'dict' };
                    }
                    
                    const decodeResult = this.#decodeBinary(token);
                    if (decodeResult !== token) {
                        return { text: decodeResult, type: 'decode' };
                    }
                    
                    return { text: token, type: 'unknown' };
                });
            }

            static #decodeBinary(token) {
                const clean = token.replace(/[^哒啊]/g, '');
                if (clean.length !== this.#config.bitLength) return token;
                
                const binStr = clean.replace(/哒/g, '1').replace(/啊/g, '0');
                try {
                    return String.fromCharCode(parseInt(binStr, 2));
                } catch {
                    return ' ';
                }
            }

            static #updateStatus(msg) {
                document.getElementById('status').textContent = msg;
            }
        }

        class App {
            static #currentMode = 'auto';
            static #debounceTimer;

            static init() {
                BearTranslator.init();
                
                document.getElementById('input').addEventListener('input', () => 
                    this.#convertWithDebounce(300));
                
                document.querySelectorAll('.mode-switch button').forEach(btn => {
                    btn.addEventListener('click', () => 
                        this.#setMode(btn.dataset.mode));
                });

                // 添加复制功能
                document.getElementById('copy-btn').addEventListener('click', () => {
                    const text = document.getElementById('conversion-result').textContent;
                    navigator.clipboard.writeText(text).then(() => {
                        this.#showCopyFeedback();
                    });
                });
            }

            static #showCopyFeedback() {
                const btn = document.getElementById('copy-btn');
                const originalText = btn.textContent;
                btn.textContent = '✅ 已复制!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 1500);
            }

            static #setMode(mode) {
                this.#currentMode = mode;
                document.querySelectorAll('.mode-switch button')
                    .forEach(b => b.classList.remove('active'));
                document.querySelector(`[data-mode="${mode}"]`)
                    .classList.add('active');
                this.#convertWithDebounce(0);
            }

            static #convertWithDebounce = (() => {
                return (delay) => {
                    clearTimeout(this.#debounceTimer);
                    this.#debounceTimer = setTimeout(() => {
                        const input = document.getElementById('input').value;
                        const result = BearTranslator.convert(input, this.#currentMode);
                        this.#updateUI(result);
                    }, delay);
                };
            })();

            static #updateUI(result) {
                const resultDiv = document.getElementById('conversion-result');
                const tagsDiv = document.getElementById('code-tags');
                
                resultDiv.textContent = result.displayText;
                
                tagsDiv.innerHTML = result.details.map(part => {
                    let tagClass = '';
                    let tagText = '';
                    switch(part.type) {
                        case 'dict': tagClass = 'dict-tag'; tagText = '词典'; break;
                        case 'symbol': tagClass = 'symbol-tag'; tagText = '符号'; break;
                        case 'encode': tagClass = 'encode-tag'; tagText = '编码'; break;
                        case 'decode': tagClass = 'decode-tag'; tagText = '解码'; break;
                        default: tagText = '未知';
                    }
                    return `<span class="output-tag ${tagClass}">${tagText}</span>`;
                }).join(' ');
            }
        }

        App.init();
    </script>
</body>
</html>
